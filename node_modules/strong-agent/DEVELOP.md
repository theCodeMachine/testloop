# Adding Features to StrongOps

## Pre-requisites

### Repos

 1. Gain access to the following repos on GitHub:
    - strongloop/strong-agent
    - NodeFly/nodefly-collector
    - NodeFly/nodefly-common
    - NodeFly/nodefly-apiserver
    - NodeFly/apm-web-app
 1. Clone all five repos. `nodefly-common` is needed for scripts, and feature
    development will be done in the other four.
 1. NodeFly repos all use
    [git-flow](http://nvie.com/posts/a-successful-git-branching-model/),
    so bleeding edge code is based on the `develop` branch rather than `master`.
    Ensure you're on the right branch in each repo before following the rest of
    these steps.

### Configuration

 1. Add the following to the root of `nodefly-collector` in a file named `.env`:

```ini
nodefly_mysql_host=localhost
nodefly_mysql_port=3306
nodefly_mysql_user=root
nodefly_mysql_database=apm
nodefly_mysql_connectionLimit=10
nodefly_mysql_queueLimit=0

nodefly_web_bind=0.0.0.0
nodefly_web_port=3001
nodefly_web_apiserver=localhost:4002
nodefly_web_urlprefix=http://localhost:3001
nodefly_web_redis_ttl=604800

nodefly_apiserver_port=4002
nodefly_apiserver_bind=0.0.0.0

nodefly_collector_bind=0.0.0.0
nodefly_collector_port=4001

nodefly_redis_host=localhost
nodefly_redis_port=6379

INTERCOM_APPID=2kzgme21
INTERCOM_SECRET=Bj1Z5Rj00uMB70_Z41Fgid075rc6Gm7FxLtWbupb

NODEFLY_WEB_GITHUB_APPSECRET=c0c290a07990710f9ff5261ac510353a45e56286
NODEFLY_WEB_GITHUB_APPID=47eb6832304718b23d1b

SPOOF_SESSION=test@strongloop.com
```

### MySQL

 1. Install MySQL.
 1. Create the required users and permissions:

```sh
echo "CREATE DATABASE apm; GRANT all ON apm.* to 'root'@'localhost';" | mysql -uroot
```

 1. Run the current migrations within `nodefly-common/sql_migrations`:

```sh
cat 00* | mysql -uroot
```

## Using Your Agent/Common

We use `npm link` to ensure the local version of `strong-agent` and
`nodefly-common` are used in place of any alternative versions. See the [npm
docs](https://npmjs.org/doc/link.html) for more information.

In short, from both the `nodefly-common` and `strong-agent` directories, run
`npm link` to symlink those packages into the globally-available directory.
Then, `npm link strong-agent` will link that version to the current package.

For example:

 1. `slc example suite`
 1. `cd sls-sample-app`
 1. `npm link strong-agent`

## Running the Cluster

In order to use `localhost` for all connections and transactions, StrongOps uses
the `SL_ENV` environment variable, looking for the value `dev`. To start your
local cluster, then, in each of `nodefly-apiserver`, `apm-web-app`, and
`nodefly-collector`, do:

 1. `npm install`
 1. `npm link nodefly-common`
 1. `SL_ENV=dev npm start`

To restart them in the future, only the last line, `SL_ENV=dev npm start` is
required.

## Running a Test App

 1. Create a test project: `slc lb project nodefly-test`
 1. Navigate a browser to `http://localhost:3001/ops/dashboard#howto`. At the
    bottom is a block of code (under the heading "2. Code") that looks like
    this:

```javascript
require('strong-agent').profile(
    'c2f80661969f119dacf1cc2bf14c62ae',
    APPLICATION_NAME,
    options // optional
);
```

 1. That second line with all the letters and numbers is your key. Copy it into
    your new project's package.json like so:

```json
  "strongAgentKey": "c2f80661969f119dacf1cc2bf14c62ae"
```

 1. Run your app: `SL_ENV=dev slc run app`
